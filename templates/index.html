<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TinyDB PhÃ¢n tÃ¡n</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Dashboard - Prototype TinyDB PhÃ¢n tÃ¡n ðŸš€</h1>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="card">
                <h2>Tráº¡ng thÃ¡i há»‡ thá»‘ng</h2>
                <ul class="node-status-list">
                    {% for node in nodes %}
                        <li>
                            <span class="status-dot {{ 'online' if node.status == 'Online' else 'offline' }}"></span>
                            <span class="node-role">{{ node.role }}</span>
                            <span class="node-status">{{ node.status }}</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            {% if log_messages %}
            <div class="card log-card">
                <h2>Nháº­t kÃ½ hoáº¡t Ä‘á»™ng</h2>
                <ul class="log-list">
                    {% for log in log_messages %}
                        <li class="log-entry">{{ log }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </aside>

        <main class="main-content">
            {% if message %}
                <div class="message {{ message_type }}">{{ message }}</div>
            {% endif %}

            <div class="features-grid">
                <div class="card">
                    <h2>TÃ­nh nÄƒng 1: Sao chÃ©p (Leader-Follower)</h2>
                    <form action="/insert" method="POST" class="feature-form">
                        <label for="name">TÃªn:</label>
                        <input type="text" id="name" name="name" required>
                        <label for="age">Tuá»•i:</label>
                        <input type="number" id="age" name="age" required>
                        <label for="city">ThÃ nh phá»‘:</label>
                        <input type="text" id="city" name="city" placeholder="VÃ­ dá»¥: Paris" required>
                        <button type="submit">ChÃ¨n (Insert)</button>
                    </form>
                </div>
                <div class="card">
                    <h2>TÃ­nh nÄƒng 2: Truy váº¥n song song (Scatter-Gather)</h2>
                    <form action="/search" method="POST" class="feature-form">
                        <label for="search_name">TÃªn (chá»©a):</label>
                        <input type="text" id="search_name" name="name" placeholder="VÃ­ dá»¥: Alice">
                        <label for="search_age">Tuá»•i (báº±ng):</label>
                        <input type="number" id="search_age" name="age" placeholder="VÃ­ dá»¥: 25">
                        <label for="search_city">ThÃ nh phá»‘ (chá»©a):</label>
                        <input type="text" id="search_city" name="city" placeholder="VÃ­ dá»¥: London">
                        <button type="submit">TÃ¬m kiáº¿m (Search)</button>
                    </form>
                </div>
            </div>

            {% if results is not none %}
                <div class="card results-card">
                    <h2>Káº¿t quáº£ tÃ¬m kiáº¿m: ({{ results|length }} báº£n ghi)</h2>
                    {% if results %}
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Nguá»“n (Node)</th>
                                    <th>TÃªn</th>
                                    <th>Tuá»•i</th>
                                    <th>ThÃ nh phá»‘</th>
                                    <th>HÃ nh Ä‘á»™ng</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in results %}
                                    <tr class="source-{{ item.source_node | replace(' ', '-') | replace('(', '') | replace(')', '') | lower }}">
                                        <td class="node-source-cell">
                                            <span class="node-badge">{{ item.source_node }}</span>
                                        </td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.age }}</td>
                                        <td>{{ item.city }}</td>
                                        <td class="action-buttons">
                                            {% if item._id %}
                                                <button class="btn-update" 
                                                        onclick="openUpdateModal('{{ item._id }}', '{{ item.name }}', '{{ item.age }}', '{{ item.city }}')">
                                                    Sá»­a
                                                </button>
                                                <button class="btn-delete" 
                                                        onclick="openDeleteModal('{{ item._id }}', '{{ item.name }}')">
                                                    XÃ³a
                                                </button>
                                            {% else %}
                                                <span class="no-action">Dá»¯ liá»‡u gá»‘c</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£ nÃ o cho truy váº¥n nÃ y.</p>
                    {% endif %}
                </div>
            {% endif %}
        </main>
    </div>

    <div id="update-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModals()">&times;</span>
            <h2>Cáº­p nháº­t báº£n ghi</h2>
            <form id="update-form" class="modal-form">
                <input type="hidden" id="update_doc_id" name="doc_id">
                <label for="update_name">TÃªn:</label>
                <input type="text" id="update_name" name="name" required>
                <label for="update_age">Tuá»•i:</label>
                <input type="number" id="update_age" name="age" required>
                <label for="update_city">ThÃ nh phá»‘:</label>
                <input type="text" id="update_city" name="city" required>
                <button type="submit">XÃ¡c nháº­n cáº­p nháº­t</button>
            </form>
        </div>
    </div>

    <div id="delete-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModals()">&times;</span>
            <h2>XÃ¡c nháº­n xÃ³a</h2>
            <p id="delete-confirmation-msg">Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n XÃ“A báº£n ghi cho: <strong><span id="delete-item-name"></span></strong>?</p>
            <p>HÃ nh Ä‘á»™ng nÃ y sáº½ Ä‘Æ°á»£c sao chÃ©p Ä‘áº¿n táº¥t cáº£ cÃ¡c nÃºt.</p>
            <input type="hidden" id="delete_doc_id">
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModals()">Há»§y</button>
                <button type="button" id="confirm-delete-btn" class="btn-delete">XÃ¡c nháº­n XÃ³a</button>
            </div>
        </div>
    </div>

    <script>
    const lastSearch = {{ last_search | tojson | safe if last_search else 'null' }};
    
    function post(path, params) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = path;

        for (const key in params) {
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = key;
            hiddenField.value = params[key];
            form.appendChild(hiddenField);
        }

        if (lastSearch && (path === '/update' || path === '/delete')) {
            const searchParams = {
                'last_search_name': lastSearch.name,
                'last_search_age': lastSearch.age,
                'last_search_city': lastSearch.city
            };
            for (const key in searchParams) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = key;
                hiddenField.value = searchParams[key];
                form.appendChild(hiddenField);
            }
        }

        document.body.appendChild(form);
        form.submit();
    }

    const updateModal = document.getElementById('update-modal');
    const deleteModal = document.getElementById('delete-modal');

    function openUpdateModal(docId, name, age, city) {
        document.getElementById('update_doc_id').value = docId;
        document.getElementById('update_name').value = name;
        document.getElementById('update_age').value = age;
        document.getElementById('update_city').value = city;
        updateModal.style.display = 'flex';
    }

    function openDeleteModal(docId, name) {
        document.getElementById('delete_doc_id').value = docId;
        document.getElementById('delete-item-name').innerText = name;
        deleteModal.style.display = 'flex';
    }

    function closeModals() {
        updateModal.style.display = 'none';
        deleteModal.style.display = 'none';
    }

    document.getElementById('update-form').addEventListener('submit', function(e) {
        e.preventDefault(); 
        const docId = document.getElementById('update_doc_id').value;
        const name = document.getElementById('update_name').value;
        const age = document.getElementById('update_age').value;
        const city = document.getElementById('update_city').value;
        post('/update', { doc_id: docId, name: name, age: age, city: city });
    });

    document.getElementById('confirm-delete-btn').addEventListener('click', function() {
        const docId = document.getElementById('delete_doc_id').value;
        post('/delete', { doc_id: docId });
    });

    window.addEventListener('click', function(e) {
        if (e.target == updateModal || e.target == deleteModal) closeModals();
    });
    </script>
</body>
</html>
