<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TinyDB Ph√¢n t√°n</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Dashboard - Prototype TinyDB Ph√¢n t√°n üöÄ</h1>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="card">
                <h2>Tr·∫°ng th√°i h·ªá th·ªëng</h2>
                <ul class="node-status-list">
                    {% for node in nodes %}
                        <li>
                            <span class="status-dot {{ 'online' if node.status == 'Online' else 'offline' }}"></span>
                            <span class="node-role">{{ node.role }}</span>
                            <span class="node-status">{{ node.status }}</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            {% if log_messages %}
            <div class="card log-card">
                <h2>Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</h2>
                <ul class="log-list">
                    {% for log in log_messages %}
                        <li class="log-entry">{{ log }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </aside>

        <main class="main-content">
            
            {% if message %}
                <div class="message {{ message_type }}">{{ message }}</div>
            {% endif %}

            <div class="features-grid">
                <div class="card">
                    <h2>T√≠nh nƒÉng 1: Sao ch√©p (Leader-Follower)</h2>
                    <form action="/insert" method="POST" class="feature-form">
                        <label for="name">T√™n:</label>
                        <input type="text" id="name" name="name" required>
                        <label for="age">Tu·ªïi:</label>
                        <input type="number" id="age" name="age" required>
                        <label for="city">Th√†nh ph·ªë:</label>
                        <input type="text" id="city" name="city" placeholder="V√≠ d·ª•: Paris" required>
                        <button type="submit">Ch√®n (Insert)</button>
                    </form>
                </div>

                <div class="card">
                    <h2>T√≠nh nƒÉng 2: Truy v·∫•n song song (Scatter-Gather)</h2>
                    <form action="/search" method="POST" class="feature-form">
                        <label for="search_name">T√™n (ch·ª©a):</label>
                        <input type="text" id="search_name" name="name" placeholder="V√≠ d·ª•: Alice">
                        <label for="search_age">Tu·ªïi (b·∫±ng):</label>
                        <input type="number" id="search_age" name="age" placeholder="V√≠ d·ª•: 25">
                        <label for="search_city">Th√†nh ph·ªë (ch·ª©a):</label>
                        <input type="text" id="search_city" name="city" placeholder="V√≠ d·ª•: London">
                        <button type="submit">T√¨m ki·∫øm (Search)</button>
                    </form>
                </div>
            </div>

            {% if results is not none %}
                <div class="card results-card">
                    <h2>K·∫øt qu·∫£ t√¨m ki·∫øm: ({{ results|length }} b·∫£n ghi)</h2>
                    {% if results %}
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Ngu·ªìn (Node)</th>
                                    <th>T√™n</th>
                                    <th>Tu·ªïi</th>
                                    <th>Th√†nh ph·ªë</th>
                                    <th>H√†nh ƒë·ªông</th> </tr>
                            </thead>
                            <tbody>
                                {% for item in results %}
                                    <tr class="source-{{ item.source_node | replace(' ', '-') | replace('(', '') | replace(')', '') | lower }}">
                                        <td class="node-source-cell">
                                            <span class="node-badge">{{ item.source_node }}</span>
                                        </td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.age }}</td>
                                        <td>{{ item.city }}</td>
                                        <td class="action-buttons">
                                            {% if item._id %}
                                                <button class="btn-update" onclick="promptForUpdate('{{ item._id }}')">S·ª≠a</button>
                                                <button class="btn-delete" onclick="confirmDelete('{{ item._id }}')">X√≥a</button>
                                            {% else %}
                                                <span class="no-action">D·ªØ li·ªáu g·ªëc</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o cho truy v·∫•n n√†y.</p>
                    {% endif %}
                </div>
            {% endif %}
        </main>
    </div>

    <script>
        // H√†m POST data b·∫±ng form ƒë·ªông
        function post(path, params) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = path;

            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = key;
                    hiddenField.value = params[key];
                    form.appendChild(hiddenField);
                }
            }
            document.body.appendChild(form);
            form.submit();
        }

        // H√†m x·ª≠ l√Ω n√∫t S·ª¨A
        function promptForUpdate(docId) {
            const newCity = prompt("Nh·∫≠p t√™n Th√†nh ph·ªë m·ªõi cho b·∫£n ghi:\n(ID: " + docId.substring(0, 8) + "...)");
            if (newCity && newCity.trim() !== "") {
                post('/update', { doc_id: docId, new_city: newCity.trim() });
            }
        }

        // H√†m x·ª≠ l√Ω n√∫t X√ìA
        function confirmDelete(docId) {
            const confirmed = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA b·∫£n ghi n√†y kh√¥ng?\n(ID: " + docId.substring(0, 8) + "...)\n\nH√†nh ƒë·ªông n√†y s·∫Ω ƒë∆∞·ª£c sao ch√©p ƒë·∫øn t·∫•t c·∫£ c√°c n√∫t!");
            if (confirmed) {
                post('/delete', { doc_id: docId });
            }
        }
    </script>
</body>
</html>